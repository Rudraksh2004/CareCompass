import jsPDF from "jspdf";

function detectRiskLevel(text: string) {
  const lower = text.toLowerCase();

  if (
    lower.includes("critical") ||
    lower.includes("abnormal") ||
    lower.includes("high risk") ||
    lower.includes("danger") ||
    lower.includes("severe")
  ) {
    return { label: "High Risk ‚ö†Ô∏è", color: [220, 38, 38] }; // red
  }

  if (
    lower.includes("fluctuating") ||
    lower.includes("elevated") ||
    lower.includes("moderate") ||
    lower.includes("variance")
  ) {
    return { label: "Moderate Risk ‚ö†Ô∏è", color: [245, 158, 11] }; // amber
  }

  return { label: "Stable / Normal üü¢", color: [34, 197, 94] }; // green
}

export const exportMedicalPDF = (
  title: string,
  originalText: string,
  aiResponse: string
) => {
  const doc = new jsPDF("p", "mm", "a4");

  const margin = 15;
  let y = 20;

  // üß† Header - CareCompass Branding
  doc.setFont("helvetica", "bold");
  doc.setFontSize(20);
  doc.setTextColor(37, 99, 235);
  doc.text("CareCompass AI", margin, y);

  y += 8;
  doc.setFontSize(14);
  doc.setTextColor(0, 0, 0);
  doc.text("AI Medical Report", margin, y);

  // Divider
  y += 5;
  doc.setDrawColor(200, 200, 200);
  doc.line(margin, y, 195, y);

  // üìÑ Report Title
  y += 10;
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("Report Type:", margin, y);

  doc.setFont("helvetica", "normal");
  doc.text(title, margin + 35, y);

  // üìä Risk Detection Badge
  const risk = detectRiskLevel(aiResponse);
  y += 10;

  doc.setFont("helvetica", "bold");
  doc.text("AI Risk Assessment:", margin, y);

  doc.setTextColor(risk.color[0], risk.color[1], risk.color[2]);
  doc.text(risk.label, margin + 50, y);

  doc.setTextColor(0, 0, 0);

  // üßæ Original Extracted Text Section
  y += 12;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Extracted Medical Text (OCR):", margin, y);

  y += 6;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);

  const originalSplit = doc.splitTextToSize(
    originalText || "No extracted text available.",
    180
  );

  doc.text(originalSplit, margin, y);
  y += originalSplit.length * 5 + 5;

  // ü§ñ AI Explanation Section
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("AI Simplified Explanation:", margin, y);

  y += 6;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);

  const aiSplit = doc.splitTextToSize(
    aiResponse || "No AI explanation generated.",
    180
  );

  doc.text(aiSplit, margin, y);
  y += aiSplit.length * 6 + 10;

  // üõ°Ô∏è Disclaimer Box
  doc.setDrawColor(220, 220, 220);
  doc.rect(margin, y, 180, 20);

  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Medical Disclaimer:", margin + 2, y + 6);

  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  doc.text(
    "This report is generated by CareCompass AI for educational and informational purposes only. It is not a medical diagnosis. Always consult a qualified healthcare professional for medical decisions.",
    margin + 2,
    y + 12,
    { maxWidth: 176 }
  );

  // Footer
  doc.setFontSize(8);
  doc.setTextColor(120, 120, 120);
  doc.text(
    `Generated by CareCompass AI ‚Ä¢ ${new Date().toLocaleString()}`,
    margin,
    285
  );

  doc.save("carecompass-ai-medical-report.pdf");
};
